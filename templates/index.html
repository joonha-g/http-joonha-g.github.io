<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì„± ë¶„ì„ê¸° - ë©”ì¸</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* --- ê¸°ì¡´ style.cssë¥¼ ë³´ì™„í•˜ëŠ” ì¶”ê°€ ìŠ¤íƒ€ì¼ --- */
        .section-divider { border: 0; height: 1px; background-color: #eee; margin: 25px 0; }
        .sort-controls { margin: 20px 0 15px 0; }
        .sort-controls span { font-weight: bold; color: #555; }
        .sort-controls select { padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-left: 10px; background-color: #fff; }
        
        .analysis-history-list { list-style-type: none; padding-left: 0; margin-top: 15px; }
        .analysis-history-list li { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }
        .analysis-history-list strong { color: #337ab7; }
        .similarity-score.high { color: #d9534f; font-weight: bold; }
        .similarity-score.mid { color: #f0ad4e; font-weight: bold; }
        .similarity-score.low { color: #5cb85c; font-weight: bold; }

        .input-form-group { margin-bottom: 15px; }
        .form-input-field { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* ë…¹ìŒê¸° ì»¨íŠ¸ë¡¤ */
        .record-controls { display: flex; gap: 15px; margin-bottom: 20px; }
        .record-controls .detect-btn { flex-grow: 1; }
        .record-controls .detect-btn:disabled { background-color: #ccc; cursor: not-allowed; opacity: 0.7; }
        .audio-playback { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        
        /* â­ï¸ ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ (ì¶”ê°€ë¨) */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid #764ba2; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* í”Œë˜ì‹œ ë©”ì‹œì§€ */
        .flash-msg { color: #e74c3c; background: #fadbd8; padding: 10px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h3>AIê°€ ì •ë°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h3>
        <p style="color: #666;">ì•½ 10~30ì´ˆ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
    </div>

    <div class="main-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1 class="logo-text-sidebar">Voice Analyze</h1>
                <p class="service-name-sidebar">ğŸ¶ ìŒì•… í‘œì ˆ ê²€ì‚¬ê¸°</p>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" class="nav-item active" data-target="overview-section"><i class="fas fa-home"></i> í™ˆ</a></li>
                    <li><a href="#" class="nav-item" data-target="similarity-section"><i class="fas fa-magnifying-glass-chart"></i> ë…¸ë˜ í‘œì ˆ ê²€ì‚¬ê¸°</a></li>
                    <li><a href="#" class="nav-item" data-target="cover-song-section"><i class="fas fa-music"></i> ì»¤ë²„ê³¡ ìœ ì‚¬ë„ ê²€ì‚¬ê¸°</a></li>
                    <li><a href="#" class="nav-item" data-target="record-create-section"><i class="fas fa-microphone-alt"></i> ìŒì„± ë…¹ìŒê¸°</a></li>
                    <li class="separator"></li>
                    <li><a href="#" class="nav-item" data-target="my-page-section"><i class="fas fa-user"></i> ë‚´ í˜ì´ì§€</a></li>
                    <li><a href="{{ url_for('logout') }}" class="nav-item logout"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</a></li>
                </ul>
            </nav>
        </aside>

        <main class="content-area">
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="card" style="margin-bottom: 20px; border-left: 5px solid #e74c3c;">
                        <p style="color: #c0392b; margin:0;">{{ messages[0] }}</p>
                    </div>
                {% endif %}
            {% endwith %}

            <section id="overview-section" class="content-section active">
                <div class="intro-left-section">
                    <h2>ìŒì„± ìœ ì‚¬ë„ ë¶„ì„ìœ¼ë¡œ <br>ë‹¹ì‹ ì˜ ì•„ì´ë””ì–´ë¥¼ ì§€í‚¤ì„¸ìš”</h2>
                    <p>ì €í¬ ì„œë¹„ìŠ¤ëŠ” ë‘ ì˜¤ë””ì˜¤ íŒŒì¼ ê°„ì˜ íŠ¹ì§•ì„ ë¹„êµí•˜ì—¬ ìœ ì‚¬ì„±ì„ íƒì§€í•˜ëŠ” AI ë„êµ¬ì…ë‹ˆë‹¤.</p>
                    <ul class="features">
                        <li><i class="fas fa-check-circle"></i> ë‘ ì˜¤ë””ì˜¤ íŒŒì¼ì˜ ì£¼ìš” íŠ¹ì§• ë¹„êµ</li>
                        <li><i class="fas fa-check-circle"></i> ìŒì„± ë° ìŒì•… íŒ¨í„´ ìœ ì‚¬ì„± ë¶„ì„</li>
                        <li><i class="fas fa-check-circle"></i> ë°±ì—”ë“œ ì•Œê³ ë¦¬ì¦˜ ì—°ë™ ì™„ë£Œ</li>
                    </ul>
                </div>
                <div class="intro-right-image">
                    <div class="placeholder-image">
                        <i class="fas fa-chart-line"></i>
                        <p>Analysis Visualization</p>
                    </div>
                </div>
            </section>

            <section id="similarity-section" class="content-section">
                <div class="card wide-card">
                    <div class="card-icon"><i class="fas fa-waveform"></i></div>
                    <h3>ë…¸ë˜ í‘œì ˆ ê²€ì‚¬ê¸°</h3>
                    <p class="card-description">ë‘ ê°œì˜ ì›ë³¸ ë…¸ë˜ì™€ í‘œì ˆ ì˜ì‹¬ ë…¸ë˜ë¥¼ ì—…ë¡œë“œí•˜ì—¬ ìœ ì‚¬ë„ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.</p>
                    
                    <form action="/analyze" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                        <div class="input-file-group">
                            <input type="text" id="file1-path" placeholder="ì›ë³¸ ì˜¤ë””ì˜¤ íŒŒì¼ (A) ì„ íƒ" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('audioFile1').click();">Browse</button>
                            <input type="file" id="audioFile1" name="file1" style="display: none;" accept="audio/*" required onchange="document.getElementById('file1-path').value = this.files[0].name;">
                        </div>
                        <div class="input-file-group">
                            <input type="text" id="file2-path" placeholder="í‘œì ˆ ì˜ì‹¬ íŒŒì¼ (B) ì„ íƒ" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('audioFile2').click();">Browse</button>
                            <input type="file" id="audioFile2" name="file2" style="display: none;" accept="audio/*" required onchange="document.getElementById('file2-path').value = this.files[0].name;">
                        </div>
                        <button type="submit" class="detect-btn">
                            <i class="fas fa-magnifying-glass"></i> í‘œì ˆ ê²€ì‚¬ ì‹œì‘
                        </button>
                    </form>
                </div>
            </section>

            <section id="cover-song-section" class="content-section">
                <div class="card wide-card">
                    <div class="card-icon"><i class="fas fa-music"></i></div>
                    <h3>ì»¤ë²„ê³¡ ìœ ì‚¬ë„ ê²€ì‚¬ê¸°</h3>
                    <p class="card-description">ì›ë³¸(MR/AR) íŒŒì¼ê³¼ ë‚´ ì»¤ë²„ê³¡ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ìœ ì‚¬ë„ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.</p>
                    
                    <form action="/analyze" method="POST" enctype="multipart/form-data" onsubmit="showLoading()">
                        <div class="input-file-group">
                            <input type="text" id="fileCover1-path" placeholder="ì›ë³¸ MR/AR íŒŒì¼ ì„ íƒ" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('audioFileCover1').click();">Browse</button>
                            <input type="file" id="audioFileCover1" name="file1" style="display: none;" accept="audio/*" required onchange="document.getElementById('fileCover1-path').value = this.files[0].name;">
                        </div>
                        <div class="input-file-group">
                            <input type="text" id="fileCover2-path" placeholder="ë‚´ ì»¤ë²„ê³¡ íŒŒì¼ ì„ íƒ" class="file-path-input" readonly>
                            <button type="button" class="browse-btn" onclick="document.getElementById('audioFileCover2').click();">Browse</button>
                            <input type="file" id="audioFileCover2" name="file2" style="display: none;" accept="audio/*" required onchange="document.getElementById('fileCover2-path').value = this.files[0].name;">
                        </div>
                        <button type="submit" class="detect-btn secondary-btn">
                            <i class="fas fa-check-double"></i> ì»¤ë²„ê³¡ ë¶„ì„ ì‹œì‘
                        </button>
                    </form>
                </div>
            </section>

            <section id="record-create-section" class="content-section">
                <div class="card wide-card">
                    <div class="card-icon"><i class="fas fa-microphone-alt"></i></div>
                    <h3>ìŒì„± ë…¹ìŒê¸°</h3>
                    <p class="card-description">ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìŒì„±ì„ ë…¹ìŒí•˜ê³  ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    
                    <div class="record-controls">
                        <button class="detect-btn" id="startRecordBtn"><i class="fas fa-play-circle"></i> ë…¹ìŒ ì‹œì‘</button>
                        <button class="detect-btn secondary-btn" id="stopRecordBtn" disabled><i class="fas fa-stop-circle"></i> ë…¹ìŒ ì¤‘ì§€</button>
                    </div>

                    <div class="audio-playback" id="playbackContainer" style="display: none;">
                        <p>ë…¹ìŒëœ ì˜¤ë””ì˜¤:</p>
                        <audio id="audioPlayback" controls style="width: 100%;"></audio>
                        <a id="downloadLink" class="detect-btn" style="display: block; margin-top: 10px; text-decoration: none; background-color: #28a745;">
                            <i class="fas fa-download"></i> ë…¹ìŒ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                        </a>
                    </div>
                </div>
            </section>

         <section id="my-page-section" class="content-section">
                <div class="card wide-card">
                    <h3>ë‚´ í˜ì´ì§€</h3>
                    <p>ì•ˆë…•í•˜ì„¸ìš”, <strong>{{ username }}</strong>ë‹˜!</p>
                    
                    <hr class="section-divider">
                    
                    <h4><i class="fas fa-history"></i> ë‚´ ë¶„ì„ ì´ë ¥</h4>
                    
                    <ul class="analysis-history-list">
                        {% if history %}
                            {% for item in history %}
                            <li>
                                <div>
                                    <strong>{{ item.result_msg }}</strong>
                                    <br>
                                    <small style="color: #777;">
                                        {{ item.created_at.strftime('%Y-%m-%d %H:%M') }} | 
                                        íŒŒì¼1: {{ item.file1_path.split('/')[-1] }}
                                    </small>
                                </div>
                                <span class="similarity-score {{ 'high' if item.similarity_score >= 80 else ('mid' if item.similarity_score >= 60 else 'low') }}">
                                    {{ item.similarity_score }}%
                                </span>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li style="justify-content: center; color: #999;">
                                ì•„ì§ ë¶„ì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë¶„ì„ì„ ì‹œì‘í•´ë³´ì„¸ìš”!
                            </li>
                        {% endif %}
                    </ul>
                    <hr class="section-divider">

                    <h4><i class="fas fa-lock"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h4>
                    
                    <form class="password-change-form" action="/change-password" method="POST">
                        
                        <div class="input-form-group">
                            <label for="current-password">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="current-password" name="current_password" class="form-input-field" placeholder="í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë¹„ë°€ë²ˆí˜¸" required>
                        </div>
                        
                        <div class="input-form-group">
                            <label for="new-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="new-password" name="new_password" class="form-input-field" placeholder="ë³€ê²½í•  ìƒˆ ë¹„ë°€ë²ˆí˜¸" required>
                        </div>
                        
                        <div class="input-form-group">
                            <label for="confirm-password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="confirm-password" name="confirm_password" class="form-input-field" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        <button type="submit" class="detect-btn">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <script>
        // 1. íƒ­ ì „í™˜ ë¡œì§
        document.addEventListener('DOMContentLoaded', function() {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.content-section');

            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    if (this.classList.contains('logout')) return; // ë¡œê·¸ì•„ì›ƒì€ ì œì™¸
                    e.preventDefault();

                    // íƒ­ í™œì„±í™”
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    // ì„¹ì…˜ í‘œì‹œ
                    const targetId = this.dataset.target;
                    sections.forEach(sec => sec.classList.remove('active'));
                    document.getElementById(targetId).classList.add('active');
                });
            });
        });

        // 2. ë¡œë”© í™”ë©´ í‘œì‹œ í•¨ìˆ˜
        function showLoading() {
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        // 3. ê°„ë‹¨ ë…¹ìŒ ë¡œì§ (wav/webm)
        const startBtn = document.getElementById('startRecordBtn');
        const stopBtn = document.getElementById('stopRecordBtn');
        const audioPlayer = document.getElementById('audioPlayback');
        const downloadLink = document.getElementById('downloadLink');
        let mediaRecorder;
        let audioChunks = [];

        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayer.src = audioUrl;
                    downloadLink.href = audioUrl;
                    downloadLink.download = 'my_recording.wav';
                    document.getElementById('playbackContainer').style.display = 'block';
                    audioChunks = [];
                };

                mediaRecorder.start();
                startBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (err) {
                alert("ë§ˆì´í¬ ì‚¬ìš© ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        });

        stopBtn.addEventListener('click', () => {
            if (mediaRecorder) {
                mediaRecorder.stop();
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });
    </script>
</body>
</html>