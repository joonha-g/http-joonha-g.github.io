<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>계정 찾기</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 400px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* 탭 스타일 */
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-size: 16px; font-weight: bold; color: #888; }
        .tab-btn.active { color: #007bff; border-bottom: 2px solid #007bff; margin-bottom: -2px; }
        
        /* 내용 영역 */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button.action-btn { width: 100%; padding: 12px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; font-size: 16px; }
        button.action-btn:hover { background-color: #0056b3; }
        
        .verify-box { display: flex; gap: 5px; }
        .verify-btn { width: 30%; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; }

        .result-box { margin-top: 15px; padding: 15px; background: #e9ecef; border-radius: 5px; text-align: center; font-weight: bold; display: none; }
        .flash { color: red; text-align: center; margin-bottom: 10px; }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #666; text-decoration: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; margin-top: 0;">계정 찾기</h2>

    <!-- 플래시 메시지 (오류 등 표시) -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash">
                {% for message in messages %}
                    {{ message }}<br>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('id-tab')">아이디 찾기</button>
        <button class="tab-btn" onclick="openTab('pw-tab')">비밀번호 찾기</button>
    </div>

    <!-- 1. 아이디 찾기 폼 -->
    <div id="id-tab" class="tab-content active">
        <p style="font-size: 14px; color: #666;">가입 시 등록한 이메일을 입력하세요.</p>
        <input type="email" id="find-id-email" placeholder="이메일 주소">
        <button class="action-btn" onclick="findId()">아이디 찾기</button>
        
        <div id="id-result" class="result-box"></div>
    </div>

    <!-- 2. 비밀번호 찾기 폼 -->
    <div id="pw-tab" class="tab-content">
        <form action="/reset-password-action" method="POST">
            <p style="font-size: 14px; color: #666;">아이디와 이메일을 모두 확인합니다.</p>
            
            <input type="text" name="username" id="pw-username" placeholder="아이디" required>
            
            <div class="verify-box">
                <input type="email" name="email" id="pw-email" placeholder="이메일" required>
                <button type="button" class="verify-btn" onclick="sendResetCode()">인증번호<br>받기</button>
            </div>

            <input type="text" name="code" placeholder="인증번호 6자리" required>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <input type="password" name="new_password" placeholder="새 비밀번호" required>
            <input type="password" name="confirm_password" placeholder="새 비밀번호 확인" required>

            <button type="submit" class="action-btn">비밀번호 변경하기</button>
        </form>
    </div>

    <a href="/login" class="back-link">로그인 화면으로 돌아가기</a>
</div>

<script>
    // 탭 전환 스크립트
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        // 버튼 활성화 스타일 처리는 간단히 생략하거나 순서대로 매핑 필요
        event.target.classList.add('active');
    }

    // 서버에서 템플릿 렌더링 시 active_tab을 받았을 경우 (오류 시 탭 유지)
    const activeTab = "{{ active_tab }}";
    if(activeTab === 'pw') {
        document.querySelectorAll('.tab-btn')[1].click();
    }

    // 1. 아이디 찾기 AJAX
    function findId() {
        const email = document.getElementById('find-id-email').value;
        if(!email) { alert("이메일을 입력하세요."); return; }

        fetch('/find-username-proc', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: email })
        })
        .then(res => res.json())
        .then(data => {
            const resultBox = document.getElementById('id-result');
            resultBox.style.display = 'block';
            if(data.success) {
                resultBox.style.color = '#007bff';
                resultBox.innerHTML = `회원님의 아이디는 <br><strong style="font-size: 1.2em;">${data.username}</strong> 입니다.`;
            } else {
                resultBox.style.color = 'red';
                resultBox.innerText = data.msg;
            }
        });
    }

    // 2. 비밀번호 재설정 인증번호 발송 AJAX
    function sendResetCode() {
        const username = document.getElementById('pw-username').value;
        const email = document.getElementById('pw-email').value;

        if(!username || !email) {
            alert("아이디와 이메일을 먼저 입력해주세요.");
            return;
        }

        fetch('/send-reset-code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ username: username, email: email })
        })
        .then(res => res.json())
        .then(data => {
            alert(data.msg);
        })
        .catch(err => {
            console.error(err);
            alert("오류가 발생했습니다.");
        });
    }
</script>

</body>
</html>